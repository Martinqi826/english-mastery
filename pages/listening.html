<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¬åŠ›è®­ç»ƒ - English Mastery</title>
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .audio-player {
      background: var(--notion-bg, #ffffff);
      border-radius: var(--radius-lg);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--notion-gray-light, #e3e2e0);
    }
    
    .audio-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
    }
    
    .audio-meta {
      color: var(--notion-gray, #9b9a97);
      font-size: 0.875rem;
      margin-bottom: var(--spacing-lg);
    }
    
    .audio-controls {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }
    
    /* Notion é£æ ¼æ’­æ”¾æŒ‰é’® */
    .play-btn {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-md, 8px);
      background: var(--notion-black, #191919);
      color: white;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.12s ease;
    }
    
    .play-btn:hover {
      background: var(--notion-dark, #37352f);
    }
    
    .play-btn:active {
      transform: scale(0.98);
    }
    
    .play-btn svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }
    
    .audio-progress {
      flex: 1;
    }
    
    .audio-progress-bar {
      height: 6px;
      background: var(--notion-gray-light, #e3e2e0);
      border-radius: var(--radius-full);
      cursor: pointer;
      position: relative;
    }
    
    .audio-progress-fill {
      height: 100%;
      background: var(--notion-black, #191919);
      border-radius: var(--radius-full);
      width: 0%;
      transition: width 0.1s;
    }
    
    .audio-time {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--notion-gray, #9b9a97);
      margin-top: var(--spacing-xs);
    }
    
    .speed-controls {
      display: flex;
      gap: var(--spacing-xs);
    }
    
    .speed-btn {
      padding: var(--spacing-xs) var(--spacing-sm);
      border: 1px solid var(--notion-gray-light, #e3e2e0);
      background: transparent;
      border-radius: var(--radius-sm, 4px);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.12s ease;
      color: var(--notion-gray, #9b9a97);
    }
    
    .speed-btn:hover {
      background: var(--notion-bg-hover, #f7f6f3);
      color: var(--notion-dark, #37352f);
    }
    
    .speed-btn.active {
      background: var(--notion-black, #191919);
      color: white;
      border-color: var(--notion-black, #191919);
    }
    
    .transcript {
      background: var(--notion-bg-hover, #f7f6f3);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      max-height: 300px;
      overflow-y: auto;
      line-height: 1.8;
    }
    
    .transcript-line {
      margin-bottom: var(--spacing-sm);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background 0.12s ease;
    }
    
    .transcript-line:hover {
      background: var(--notion-gray-lighter, #f1f1ef);
    }
    
    .transcript-line.active {
      background: var(--notion-blue, #2383e2);
      color: white;
    }
    
    .transcript-time {
      font-size: 0.75rem;
      color: var(--notion-gray, #9b9a97);
      margin-right: var(--spacing-sm);
    }
    
    .transcript-line.active .transcript-time {
      color: rgba(255,255,255,0.8);
    }
    
    .quiz-section {
      background: var(--notion-bg, #ffffff);
      border-radius: var(--radius-lg);
      padding: var(--spacing-xl);
      margin-top: var(--spacing-lg);
      border: 1px solid var(--notion-gray-light, #e3e2e0);
    }
    
    .quiz-question {
      font-size: 1.125rem;
      font-weight: 500;
      margin-bottom: var(--spacing-lg);
    }
    
    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }
    
    .quiz-option {
      padding: var(--spacing-md);
      border: 1px solid var(--notion-gray-light, #e3e2e0);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.12s ease;
    }
    
    .quiz-option:hover {
      border-color: var(--notion-gray, #9b9a97);
      background: var(--notion-bg-hover, #f7f6f3);
    }
    
    .quiz-option.selected {
      border-color: var(--notion-blue, #2383e2);
      background: var(--notion-blue, #2383e2);
      color: white;
    }
    
    .quiz-option.correct {
      border-color: var(--success-color);
      background: var(--success-color);
      color: white;
    }
    
    .quiz-option.wrong {
      border-color: var(--danger-color);
      background: var(--danger-color);
      color: white;
    }
    
    .materials-list {
      display: grid;
      gap: var(--spacing-md);
    }
    
    .material-card {
      background: var(--notion-bg, #ffffff);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      border: 1px solid var(--notion-gray-light, #e3e2e0);
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      cursor: pointer;
      transition: all 0.12s ease;
    }
    
    .material-card:hover {
      border-color: var(--notion-gray, #9b9a97);
      box-shadow: var(--shadow-md);
    }
    
    .material-card.completed {
      border-color: var(--notion-green, #0f7b6c);
      background: rgba(15, 123, 108, 0.05);
    }
    
    .material-icon {
      font-size: 2rem;
    }
    
    .material-info {
      flex: 1;
    }
    
    .material-title {
      font-weight: 600;
      margin-bottom: var(--spacing-xs);
    }
    
    .material-meta {
      font-size: 0.875rem;
      color: var(--notion-gray, #9b9a97);
    }
    
    .material-status {
      font-size: 1.5rem;
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <!-- Header -->
    <header class="header">
      <div class="container">
        <div class="header-content">
          <div class="logo">
            <span class="logo-icon">ğŸ¯</span>
            <span>English Mastery</span>
          </div>
          <div class="day-badge" id="dayBadge">Day 1 / 30</div>
        </div>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
      <div class="container">
        <ul class="nav-list">
          <li class="nav-item"><a href="../index.html" class="nav-link"><span>â—‰</span> ä»ªè¡¨ç›˜</a></li>
          <li class="nav-item"><a href="vocabulary.html" class="nav-link"><span>â—‡</span> è¯æ±‡å­¦ä¹ </a></li>
          <li class="nav-item"><a href="listening.html" class="nav-link active"><span>â—†</span> å¬åŠ›è®­ç»ƒ</a></li>
          <li class="nav-item"><a href="reading.html" class="nav-link"><span>â—‡</span> é˜…è¯»ç»ƒä¹ </a></li>
          <li class="nav-item"><a href="writing.html" class="nav-link"><span>â—‡</span> å†™ä½œç»ƒä¹ </a></li>
          <li class="nav-item"><a href="test.html" class="nav-link"><span>â—‡</span> æµ‹è¯•è¯„ä¼°</a></li>
          <li class="nav-item"><a href="calendar.html" class="nav-link"><span>â—‡</span> æ‰“å¡æ—¥å†</a></li>
          <li class="nav-item"><a href="materials.html" class="nav-link"><span>â—‡</span> æˆ‘çš„ç´ æ</a></li>
        </ul>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="container">
        <h1 style="margin-bottom: var(--spacing-lg);">ğŸ‘‚ å¬åŠ›è®­ç»ƒ</h1>
        
        <!-- Materials List -->
        <div class="card" style="margin-bottom: var(--spacing-xl);">
          <div class="card-header">
            <h2 class="card-title"><span>ğŸ“»</span> ä»Šæ—¥å¬åŠ›ææ–™</h2>
            <span class="text-muted" id="listeningProgress">0/3 å®Œæˆ</span>
          </div>
          <div class="card-body">
            <div class="materials-list" id="materialsList">
              <div class="material-card" onclick="selectMaterial(0)">
                <div class="material-icon">ğŸ™ï¸</div>
                <div class="material-info">
                  <div class="material-title">TED Talk: The Power of Introverts</div>
                  <div class="material-meta">æ—¶é•¿: 5:30 | éš¾åº¦: ä¸­ç­‰</div>
                </div>
                <div class="material-status" id="status-0">â—‹</div>
              </div>
              <div class="material-card" onclick="selectMaterial(1)">
                <div class="material-icon">ğŸ’¼</div>
                <div class="material-info">
                  <div class="material-title">Business Meeting: Project Discussion</div>
                  <div class="material-meta">æ—¶é•¿: 3:45 | éš¾åº¦: ä¸­ç­‰</div>
                </div>
                <div class="material-status" id="status-1">â—‹</div>
              </div>
              <div class="material-card" onclick="selectMaterial(2)">
                <div class="material-icon">ğŸ“</div>
                <div class="material-info">
                  <div class="material-title">Phone Call: Client Follow-up</div>
                  <div class="material-meta">æ—¶é•¿: 2:20 | éš¾åº¦: ç®€å•</div>
                </div>
                <div class="material-status" id="status-2">â—‹</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Audio Player -->
        <div class="audio-player" id="playerSection">
          <div class="audio-title" id="audioTitle">TED Talk: The Power of Introverts</div>
          <div class="audio-meta" id="audioMeta">Susan Cain | å•†åŠ¡æ²Ÿé€š | ä¸­ç­‰éš¾åº¦</div>
          
          <div class="audio-controls">
            <button class="play-btn" id="playBtn" onclick="togglePlay()" title="æ’­æ”¾/æš‚åœ">
              <svg id="playIcon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 5v14l11-7z"/>
              </svg>
              <svg id="pauseIcon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="display:none;">
                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
              </svg>
            </button>
            <div class="audio-progress">
              <div class="audio-progress-bar" onclick="seek(event)">
                <div class="audio-progress-fill" id="audioProgress"></div>
              </div>
              <div class="audio-time">
                <span id="currentTime">0:00</span>
                <span id="totalTime">5:30</span>
              </div>
            </div>
            <div class="speed-controls">
              <button class="speed-btn" onclick="setSpeed(0.75)">0.75x</button>
              <button class="speed-btn active" onclick="setSpeed(1)">1x</button>
              <button class="speed-btn" onclick="setSpeed(1.25)">1.25x</button>
              <button class="speed-btn" onclick="setSpeed(1.5)">1.5x</button>
            </div>
          </div>
          
          <div class="card-header" style="padding: 0; border: none; margin-bottom: var(--spacing-md);">
            <h3 class="card-title"><span>ğŸ“</span> æ–‡å­—ç¨¿</h3>
            <button class="btn btn-secondary" onclick="toggleTranscript()">æ˜¾ç¤º/éšè—</button>
          </div>
          
          <div class="transcript" id="transcript">
            <div class="transcript-line" data-time="0">
              <span class="transcript-time">0:00</span>
              When I was nine years old, I went off to summer camp for the first time.
            </div>
            <div class="transcript-line" data-time="5">
              <span class="transcript-time">0:05</span>
              And my mother packed me a suitcase full of books.
            </div>
            <div class="transcript-line" data-time="10">
              <span class="transcript-time">0:10</span>
              Which to me seemed like a perfectly natural thing to do.
            </div>
            <div class="transcript-line" data-time="15">
              <span class="transcript-time">0:15</span>
              Because in my family, reading was the primary group activity.
            </div>
            <div class="transcript-line" data-time="20">
              <span class="transcript-time">0:20</span>
              And this might sound antisocial to you, but for us it was really just a different way of being social.
            </div>
            <div class="transcript-line" data-time="28">
              <span class="transcript-time">0:28</span>
              You have the warmth of your family sitting right next to you.
            </div>
            <div class="transcript-line" data-time="33">
              <span class="transcript-time">0:33</span>
              But you are also free to go roaming around the adventureland inside your own mind.
            </div>
            <div class="transcript-line" data-time="40">
              <span class="transcript-time">0:40</span>
              And I had this idea that camp was going to be just like this, but better.
            </div>
            <div class="transcript-line" data-time="46">
              <span class="transcript-time">0:46</span>
              I had a vision of 10 girls sitting in a cabin cozily reading books in their matching nightgowns.
            </div>
          </div>
        </div>
        
        <!-- Quiz Section -->
        <div class="quiz-section" id="quizSection">
          <h3 class="card-title" style="margin-bottom: var(--spacing-lg);"><span>â“</span> ç†è§£æµ‹è¯•</h3>
          
          <div id="quizContainer">
            <div class="quiz-question" id="quizQuestion">
              1. What did the speaker's mother pack for summer camp?
            </div>
            <div class="quiz-options" id="quizOptions">
              <div class="quiz-option" onclick="selectOption(this, 0)">A. Clothes and snacks</div>
              <div class="quiz-option" onclick="selectOption(this, 1)">B. A suitcase full of books</div>
              <div class="quiz-option" onclick="selectOption(this, 2)">C. Sports equipment</div>
              <div class="quiz-option" onclick="selectOption(this, 3)">D. Electronic devices</div>
            </div>
            
            <div style="margin-top: var(--spacing-lg); text-align: center;">
              <button class="btn btn-primary btn-lg" id="submitQuiz" onclick="submitAnswer()">æäº¤ç­”æ¡ˆ</button>
              <button class="btn btn-success btn-lg hidden" id="nextQuestion" onclick="nextQuestion()">ä¸‹ä¸€é¢˜</button>
            </div>
          </div>
          
          <div id="quizComplete" class="hidden" style="text-align: center; padding: var(--spacing-xl);">
            <div style="font-size: 4rem; margin-bottom: var(--spacing-lg);">ğŸ‰</div>
            <h2>å¬åŠ›ç»ƒä¹ å®Œæˆï¼</h2>
            <p class="text-muted mt-md">æ­£ç¡®ç‡: <span id="accuracy">0</span>%</p>
            <button class="btn btn-primary btn-lg mt-lg" onclick="location.href='../index.html'">è¿”å›ä»ªè¡¨ç›˜</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="../js/storage.js"></script>
  <script>
    // å¬åŠ›ææ–™æ•°æ®
    const materials = [
      {
        title: "TED Talk: The Power of Introverts",
        speaker: "Susan Cain",
        category: "å•†åŠ¡æ²Ÿé€š",
        difficulty: "ä¸­ç­‰",
        duration: "5:30",
        transcript: [
          { time: 0, text: "When I was nine years old, I went off to summer camp for the first time." },
          { time: 5, text: "And my mother packed me a suitcase full of books." },
          { time: 10, text: "Which to me seemed like a perfectly natural thing to do." },
          { time: 15, text: "Because in my family, reading was the primary group activity." },
          { time: 20, text: "And this might sound antisocial to you, but for us it was really just a different way of being social." },
          { time: 28, text: "You have the warmth of your family sitting right next to you." },
          { time: 33, text: "But you are also free to go roaming around the adventureland inside your own mind." },
          { time: 40, text: "And I had this idea that camp was going to be just like this, but better." },
          { time: 46, text: "I had a vision of 10 girls sitting in a cabin cozily reading books in their matching nightgowns." }
        ],
        questions: [
          {
            question: "What did the speaker's mother pack for summer camp?",
            options: ["Clothes and snacks", "A suitcase full of books", "Sports equipment", "Electronic devices"],
            correct: 1
          },
          {
            question: "How did the speaker's family view reading together?",
            options: ["As antisocial behavior", "As a different way of being social", "As a waste of time", "As mandatory activity"],
            correct: 1
          }
        ]
      },
      {
        title: "Business Meeting: Project Discussion",
        speaker: "Team Lead",
        category: "å·¥ä½œåœºæ™¯",
        difficulty: "ä¸­ç­‰",
        duration: "3:45",
        transcript: [
          { time: 0, text: "Good morning everyone. Let's get started with our weekly project meeting." },
          { time: 5, text: "First, I'd like to review our progress from last week." },
          { time: 10, text: "The development team has completed the first phase of the project." },
          { time: 15, text: "We're now moving into the testing phase, which will take about two weeks." },
          { time: 22, text: "I need everyone to submit their status reports by Friday." },
          { time: 28, text: "Are there any questions or concerns about the timeline?" },
          { time: 35, text: "Great. Let's meet again next Monday to review our progress." }
        ],
        questions: [
          {
            question: "What is the main topic of the meeting?",
            options: ["Budget review", "Project timeline", "Team building", "Performance review"],
            correct: 1
          }
        ]
      },
      {
        title: "Phone Call: Client Follow-up",
        speaker: "Sales Rep",
        category: "å®¢æˆ·æ²Ÿé€š",
        difficulty: "ç®€å•",
        duration: "2:20",
        transcript: [
          { time: 0, text: "Hello, this is John from ABC Company. How are you today?" },
          { time: 5, text: "I'm calling to follow up on the proposal we sent last week." },
          { time: 10, text: "Have you had a chance to review the pricing and terms?" },
          { time: 15, text: "I understand you might need more time to discuss with your team." },
          { time: 22, text: "Please feel free to contact me if you have any questions." },
          { time: 28, text: "I look forward to hearing from you soon. Have a great day!" }
        ],
        questions: [
          {
            question: "What is the purpose of the call?",
            options: ["To complain", "To follow up on a proposal", "To cancel a meeting", "To request a refund"],
            correct: 1
          }
        ]
      }
    ];
    
    let currentMaterial = 0;
    let currentQuestion = 0;
    let selectedAnswer = -1;
    let correctCount = 0;
    let completedMaterials = [];
    let isPlaying = false;
    let playbackRate = 1;
    let currentLineIndex = 0;
    
    document.addEventListener('DOMContentLoaded', function() {
      updateDayBadge();
      loadProgress();
      updateUI();
      
      // é¢„åŠ è½½è¯­éŸ³åˆ—è¡¨
      if (window.speechSynthesis) {
        speechSynthesis.getVoices();
        speechSynthesis.onvoiceschanged = () => {
          speechSynthesis.getVoices();
        };
      }
    });
    
    function updateDayBadge() {
      const currentDay = Storage.getCurrentDay();
      document.getElementById('dayBadge').textContent = `Day ${currentDay} / 30`;
    }
    
    function loadProgress() {
      const saved = localStorage.getItem('em_listening_progress');
      if (saved) {
        const data = JSON.parse(saved);
        if (data.date === Storage.getTodayString()) {
          completedMaterials = data.completedMaterials || [];
        }
      }
    }
    
    function saveProgress() {
      localStorage.setItem('em_listening_progress', JSON.stringify({
        date: Storage.getTodayString(),
        completedMaterials
      }));
    }
    
    function updateUI() {
      // æ›´æ–°ææ–™åˆ—è¡¨çŠ¶æ€
      completedMaterials.forEach(index => {
        const card = document.querySelectorAll('.material-card')[index];
        const status = document.getElementById(`status-${index}`);
        if (card) card.classList.add('completed');
        if (status) status.textContent = 'âœ…';
      });
      
      document.getElementById('listeningProgress').textContent = `${completedMaterials.length}/3 å®Œæˆ`;
    }
    
    function selectMaterial(index) {
      // åœæ­¢å½“å‰æ’­æ”¾
      if (isPlaying) {
        pausePlayback();
      }
      
      currentMaterial = index;
      currentQuestion = 0;
      correctCount = 0;
      selectedAnswer = -1;
      currentLineIndex = 0;
      
      const material = materials[index];
      document.getElementById('audioTitle').textContent = material.title;
      document.getElementById('audioMeta').textContent = `${material.speaker} | ${material.category} | ${material.difficulty}éš¾åº¦`;
      document.getElementById('totalTime').textContent = material.duration;
      document.getElementById('currentTime').textContent = '0:00';
      document.getElementById('audioProgress').style.width = '0%';
      
      // æ›´æ–°æ–‡å­—ç¨¿
      const transcriptContainer = document.getElementById('transcript');
      transcriptContainer.innerHTML = material.transcript.map(line => {
        const minutes = Math.floor(line.time / 60);
        const seconds = line.time % 60;
        const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        return `
          <div class="transcript-line" data-time="${line.time}">
            <span class="transcript-time">${timeStr}</span>
            ${line.text}
          </div>
        `;
      }).join('');
      
      // é«˜äº®é€‰ä¸­çš„ææ–™å¡ç‰‡
      document.querySelectorAll('.material-card').forEach((card, i) => {
        if (i === index) {
          card.style.borderColor = 'var(--notion-blue, #2383e2)';
        } else {
          card.style.borderColor = completedMaterials.includes(i) ? 'var(--notion-green, #0f7b6c)' : 'var(--notion-gray-light, #e3e2e0)';
        }
      });
      
      showQuestion();
      document.getElementById('quizComplete').classList.add('hidden');
      document.getElementById('quizContainer').classList.remove('hidden');
    }
    
    function togglePlay() {
      if (isPlaying) {
        pausePlayback();
      } else {
        startPlayback();
      }
    }
    
    function startPlayback() {
      isPlaying = true;
      updatePlayButton();
      
      // ä½¿ç”¨ Web Speech API æœ—è¯»æ–‡å­—ç¨¿
      if (!window.speechSynthesis) {
        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½');
        isPlaying = false;
        updatePlayButton();
        return;
      }
      
      // åœæ­¢ä¹‹å‰çš„è¯­éŸ³
      speechSynthesis.cancel();
      
      // è·å–æ‰€æœ‰æ–‡å­—ç¨¿è¡Œ
      const lines = document.querySelectorAll('.transcript-line');
      const texts = Array.from(lines).map(line => {
        // è·å–çº¯æ–‡æœ¬ï¼ˆä¸åŒ…å«æ—¶é—´æˆ³ï¼‰
        const clone = line.cloneNode(true);
        const timeSpan = clone.querySelector('.transcript-time');
        if (timeSpan) timeSpan.remove();
        return clone.textContent.trim();
      });
      
      currentLineIndex = 0;
      speakNextLine(texts, lines);
    }
    
    function speakNextLine(texts, lines) {
      if (!isPlaying || currentLineIndex >= texts.length) {
        if (currentLineIndex >= texts.length) {
          // æ’­æ”¾å®Œæˆ
          isPlaying = false;
          updatePlayButton();
          document.getElementById('audioProgress').style.width = '100%';
        }
        return;
      }
      
      // é«˜äº®å½“å‰è¡Œ
      lines.forEach((line, i) => {
        if (i === currentLineIndex) {
          line.classList.add('active');
          // æ»šåŠ¨åˆ°å½“å‰è¡Œ
          line.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          line.classList.remove('active');
        }
      });
      
      // æ›´æ–°è¿›åº¦æ¡
      const progress = ((currentLineIndex + 1) / texts.length) * 100;
      document.getElementById('audioProgress').style.width = `${progress}%`;
      
      // æ›´æ–°æ—¶é—´æ˜¾ç¤º
      const currentLine = lines[currentLineIndex];
      const lineTime = parseInt(currentLine.dataset.time);
      const minutes = Math.floor(lineTime / 60);
      const seconds = lineTime % 60;
      document.getElementById('currentTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // æœ—è¯»å½“å‰è¡Œ
      const utterance = new SpeechSynthesisUtterance(texts[currentLineIndex]);
      utterance.lang = 'en-US';
      utterance.rate = playbackRate;
      utterance.pitch = 1;
      utterance.volume = 1;
      
      // è·å–è‹±è¯­è¯­éŸ³
      const voices = speechSynthesis.getVoices();
      const englishVoice = voices.find(v => v.lang === 'en-US') ||
                          voices.find(v => v.lang.startsWith('en-US')) ||
                          voices.find(v => v.lang.includes('en')) ||
                          voices.find(v => v.lang === 'en-GB');
      if (englishVoice) {
        utterance.voice = englishVoice;
      }
      
      utterance.onend = () => {
        currentLineIndex++;
        speakNextLine(texts, lines);
      };
      
      utterance.onerror = () => {
        currentLineIndex++;
        speakNextLine(texts, lines);
      };
      
      speechSynthesis.speak(utterance);
    }
    
    function pausePlayback() {
      isPlaying = false;
      updatePlayButton();
      if (window.speechSynthesis) {
        speechSynthesis.cancel();
      }
    }
    
    function updatePlayButton() {
      const playIcon = document.getElementById('playIcon');
      const pauseIcon = document.getElementById('pauseIcon');
      if (isPlaying) {
        playIcon.style.display = 'none';
        pauseIcon.style.display = 'block';
      } else {
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
      }
    }
    
    function setSpeed(speed) {
      playbackRate = speed;
      document.querySelectorAll('.speed-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°å¼€å§‹ä»¥åº”ç”¨æ–°é€Ÿåº¦
      if (isPlaying) {
        pausePlayback();
        setTimeout(() => startPlayback(), 100);
      }
    }
    
    function toggleTranscript() {
      const transcript = document.getElementById('transcript');
      transcript.style.display = transcript.style.display === 'none' ? 'block' : 'none';
    }
    
    function showQuestion() {
      const material = materials[currentMaterial];
      if (currentQuestion >= material.questions.length) {
        completeListening();
        return;
      }
      
      const q = material.questions[currentQuestion];
      document.getElementById('quizQuestion').textContent = `${currentQuestion + 1}. ${q.question}`;
      
      const optionsHtml = q.options.map((opt, i) => 
        `<div class="quiz-option" onclick="selectOption(this, ${i})">${String.fromCharCode(65 + i)}. ${opt}</div>`
      ).join('');
      document.getElementById('quizOptions').innerHTML = optionsHtml;
      
      document.getElementById('submitQuiz').classList.remove('hidden');
      document.getElementById('nextQuestion').classList.add('hidden');
      selectedAnswer = -1;
    }
    
    function selectOption(element, index) {
      document.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
      element.classList.add('selected');
      selectedAnswer = index;
    }
    
    function submitAnswer() {
      if (selectedAnswer === -1) {
        alert('è¯·é€‰æ‹©ä¸€ä¸ªç­”æ¡ˆ');
        return;
      }
      
      const material = materials[currentMaterial];
      const q = material.questions[currentQuestion];
      const options = document.querySelectorAll('.quiz-option');
      
      if (selectedAnswer === q.correct) {
        options[selectedAnswer].classList.add('correct');
        correctCount++;
      } else {
        options[selectedAnswer].classList.add('wrong');
        options[q.correct].classList.add('correct');
      }
      
      document.getElementById('submitQuiz').classList.add('hidden');
      document.getElementById('nextQuestion').classList.remove('hidden');
    }
    
    function nextQuestion() {
      currentQuestion++;
      showQuestion();
    }
    
    function completeListening() {
      if (!completedMaterials.includes(currentMaterial)) {
        completedMaterials.push(currentMaterial);
        saveProgress();
      }
      
      const material = materials[currentMaterial];
      const accuracy = Math.round((correctCount / material.questions.length) * 100);
      
      document.getElementById('quizContainer').classList.add('hidden');
      document.getElementById('quizComplete').classList.remove('hidden');
      document.getElementById('accuracy').textContent = accuracy;
      
      updateUI();
      
      // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
      if (completedMaterials.length >= 3) {
        Storage.updateTodayTask('listening', true);
        Storage.addStudyTime(15);
        
        const progress = Storage.getProgress();
        progress.listening = Math.min(100, (progress.listening || 35) + 2);
        Storage.setProgress(progress);
      }
    }
  </script>
</body>
</html>
