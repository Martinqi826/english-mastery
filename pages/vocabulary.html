<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯æ±‡å­¦ä¹  - English Mastery</title>
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .vocab-card {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-md);
      text-align: center;
    }
    
    .vocab-word {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: var(--spacing-md);
    }
    
    .vocab-phonetic {
      font-size: 1.25rem;
      color: var(--text-muted);
      font-family: var(--font-mono);
      margin-bottom: var(--spacing-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
    }
    
    /* Notion é£æ ¼å‘éŸ³æŒ‰é’® - é€æ˜èƒŒæ™¯ + ç°è‰²å›¾æ ‡ */
    .speak-btn {
      background: transparent;
      border: none;
      border-radius: var(--radius-md, 8px);
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.12s ease;
      color: var(--notion-gray, #9b9a97);
    }
    
    .speak-btn:hover {
      background: var(--notion-bg-hover, #f7f6f3);
      color: var(--notion-dark, #37352f);
    }
    
    .speak-btn:active {
      background: var(--notion-gray-lighter, #f1f1ef);
    }
    
    .speak-btn.speaking {
      color: var(--notion-blue, #2383e2);
      animation: speakPulse 0.8s ease infinite;
    }
    
    @keyframes speakPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .speak-btn svg {
      width: 20px;
      height: 20px;
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    /* Notion é£æ ¼è¿·ä½ å‘éŸ³æŒ‰é’® */
    .speak-btn-mini {
      background: transparent;
      border: none;
      border-radius: var(--radius-sm, 4px);
      width: 28px;
      height: 28px;
      min-width: 28px;
      min-height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.12s ease;
      margin-left: var(--spacing-xs, 4px);
      flex-shrink: 0;
      color: var(--notion-gray, #9b9a97);
    }
    
    .speak-btn-mini:hover {
      background: var(--notion-bg-hover, #f7f6f3);
      color: var(--notion-dark, #37352f);
    }
    
    .speak-btn-mini.speaking {
      color: var(--notion-blue, #2383e2);
    }
    
    .speak-btn-mini svg {
      width: 16px;
      height: 16px;
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    .vocab-meaning {
      font-size: 1.25rem;
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .vocab-example {
      background: var(--notion-bg-hover, #f7f6f3);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      font-style: italic;
      color: var(--notion-gray-dark, #787774);
      margin-bottom: var(--spacing-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
    }
    
    .vocab-example-text {
      flex: 1;
      text-align: center;
    }
    
    .vocab-controls {
      display: flex;
      gap: var(--spacing-md);
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .vocab-btn {
      padding: var(--spacing-md) var(--spacing-xl);
      border: none;
      border-radius: var(--radius-md);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .vocab-btn.show {
      background: var(--notion-black, #191919);
      color: white;
      box-shadow: var(--shadow-sm);
    }
    
    .vocab-btn.know {
      background: var(--notion-green, #0f7b6c);
      color: white;
      box-shadow: var(--shadow-sm);
    }
    
    .vocab-btn.unknown {
      background: var(--notion-orange, #d9730d);
      color: white;
      box-shadow: var(--shadow-sm);
    }
    
    .vocab-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      opacity: 0.9;
    }
    
    .vocab-progress {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
    }
    
    .vocab-progress-bar {
      flex: 1;
      height: 8px;
      background: var(--progress-bg);
      border-radius: var(--radius-full);
      overflow: hidden;
    }
    
    .vocab-progress-fill {
      height: 100%;
      background: var(--success-color);
      border-radius: var(--radius-full);
      transition: width 0.3s;
    }
    
    .vocab-progress-text {
      font-size: 0.875rem;
      color: var(--text-muted);
      white-space: nowrap;
    }
    
    .vocab-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: var(--spacing-md);
    }
    
    .vocab-item {
      background: var(--bg-primary);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .vocab-item:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }
    
    .vocab-item.learned {
      background: var(--success-color);
      color: white;
      border-color: var(--success-color);
    }
    
    .vocab-item-word {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 600;
      margin-bottom: var(--spacing-xs);
    }
    
    .vocab-item-word-text {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .vocab-item-meaning {
      font-size: 0.875rem;
      color: var(--text-muted);
    }
    
    .vocab-item.learned .vocab-item-meaning {
      color: rgba(255,255,255,0.8);
    }
    
    .hidden {
      visibility: hidden;
    }
    
    .tabs {
      display: flex;
      gap: var(--spacing-xs);
      margin-bottom: var(--spacing-lg);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: var(--spacing-sm);
    }
    
    .tab {
      padding: var(--spacing-sm) var(--spacing-lg);
      background: none;
      border: none;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      transition: all 0.2s;
    }
    
    .tab:hover {
      color: var(--text-primary);
    }
    
    .tab.active {
      color: var(--primary-color);
      background: var(--bg-tertiary);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <!-- Header -->
    <header class="header">
      <div class="container">
        <div class="header-content">
          <div class="logo">
            <span class="logo-icon">ğŸ¯</span>
            <span>English Mastery</span>
          </div>
          <div class="day-badge" id="dayBadge">Day 1 / 30</div>
        </div>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
      <div class="container">
        <ul class="nav-list">
          <li class="nav-item">
            <a href="../index.html" class="nav-link">
              <span>â—‰</span> ä»ªè¡¨ç›˜
            </a>
          </li>
          <li class="nav-item">
            <a href="vocabulary.html" class="nav-link active">
              <span>â—†</span> è¯æ±‡å­¦ä¹ 
            </a>
          </li>
          <li class="nav-item">
            <a href="listening.html" class="nav-link">
              <span>â—‡</span> å¬åŠ›è®­ç»ƒ
            </a>
          </li>
          <li class="nav-item">
            <a href="reading.html" class="nav-link">
              <span>â—‡</span> é˜…è¯»ç»ƒä¹ 
            </a>
          </li>
          <li class="nav-item">
            <a href="writing.html" class="nav-link">
              <span>â—‡</span> å†™ä½œç»ƒä¹ 
            </a>
          </li>
          <li class="nav-item">
            <a href="test.html" class="nav-link">
              <span>â—‡</span> æµ‹è¯•è¯„ä¼°
            </a>
          </li>
          <li class="nav-item">
            <a href="calendar.html" class="nav-link">
              <span>â—‡</span> æ‰“å¡æ—¥å†
            </a>
          </li>
          <li class="nav-item">
            <a href="materials.html" class="nav-link">
              <span>â—‡</span> æˆ‘çš„ç´ æ
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="container">
        <h1 style="margin-bottom: var(--spacing-lg);">ğŸ“– è¯æ±‡å­¦ä¹ </h1>
        
        <!-- Tabs -->
        <div class="tabs">
          <button class="tab active" onclick="switchTab('flashcard')">é—ªå¡å­¦ä¹ </button>
          <button class="tab" onclick="switchTab('list')">è¯æ±‡åˆ—è¡¨</button>
        </div>
        
        <!-- Flashcard Mode -->
        <div id="flashcard-tab" class="tab-content active">
          <!-- Progress -->
          <div class="vocab-progress">
            <span class="vocab-progress-text" id="progressText">0 / 30</span>
            <div class="vocab-progress-bar">
              <div class="vocab-progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <span class="vocab-progress-text" id="learnedCount">å·²å­¦ 0 è¯</span>
          </div>
          
          <!-- Flashcard -->
          <div class="vocab-card" id="vocabCard">
            <div class="vocab-word" id="vocabWord">Loading...</div>
            <div class="vocab-phonetic">
              <span id="vocabPhonetic">/ËˆloÊŠdÉªÅ‹/</span>
              <button class="speak-btn" id="speakBtn" onclick="speakWord()" title="æ’­æ”¾å‘éŸ³">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                  <path d="M15.54 8.46a5 5 0 010 7.07"/>
                  <path d="M19.07 4.93a10 10 0 010 14.14"/>
                </svg>
              </button>
            </div>
            <div class="vocab-meaning hidden" id="vocabMeaning">åŠ è½½ä¸­...</div>
            <div class="vocab-example hidden" id="vocabExample">
              <span class="vocab-example-text" id="vocabExampleText">"Example sentence loading..."</span>
              <button class="speak-btn-mini" id="speakExampleBtn" onclick="speakExample()" title="æ’­æ”¾ä¾‹å¥å‘éŸ³">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                  <path d="M15.54 8.46a5 5 0 010 7.07"/>
                </svg>
              </button>
            </div>
            
            <div class="vocab-controls">
              <button class="vocab-btn show" id="showBtn" onclick="showMeaning()">æ˜¾ç¤ºé‡Šä¹‰</button>
              <button class="vocab-btn unknown hidden" id="unknownBtn" onclick="markUnknown()">ä¸è®¤è¯†</button>
              <button class="vocab-btn know hidden" id="knowBtn" onclick="markKnown()">è®¤è¯†</button>
            </div>
          </div>
          
          <!-- Complete Message -->
          <div class="card hidden" id="completeCard" style="text-align: center; padding: var(--spacing-2xl);">
            <div style="font-size: 4rem; margin-bottom: var(--spacing-lg);">ğŸ‰</div>
            <h2>ä»Šæ—¥è¯æ±‡å­¦ä¹ å®Œæˆï¼</h2>
            <p class="text-muted mt-md">ä½ å·²ç»å­¦ä¹ äº† 30 ä¸ªæ–°è¯æ±‡</p>
            <button class="btn btn-primary btn-lg mt-lg" onclick="location.href='../index.html'">
              è¿”å›ä»ªè¡¨ç›˜
            </button>
          </div>
        </div>
        
        <!-- List Mode -->
        <div id="list-tab" class="tab-content">
          <div class="vocab-list" id="vocabList">
            <!-- Generated by JS -->
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="../js/storage.js"></script>
  <script src="../js/materials.js"></script>
  <script>
    // ========== æ¨¡å¼æ£€æµ‹ ==========
    const urlParams = new URLSearchParams(window.location.search);
    const materialId = urlParams.get('material');
    const isCustomMode = !!materialId;
    
    // ä»Šæ—¥è¯æ±‡æ•°æ®ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰
    let todayVocabulary = [
      { word: "agenda", phonetic: "/É™ËˆdÊ’endÉ™/", meaning: "è®®ç¨‹ï¼›æ—¥ç¨‹è¡¨", example: "Let's go through today's agenda." },
      { word: "deadline", phonetic: "/ËˆdedlaÉªn/", meaning: "æˆªæ­¢æ—¥æœŸ", example: "The deadline for this project is next Friday." },
      { word: "collaborate", phonetic: "/kÉ™ËˆlÃ¦bÉ™reÉªt/", meaning: "åˆä½œï¼›åä½œ", example: "We need to collaborate with the marketing team." },
      { word: "implement", phonetic: "/ËˆÉªmplÉªment/", meaning: "å®æ–½ï¼›æ‰§è¡Œ", example: "We will implement the new policy next month." },
      { word: "feedback", phonetic: "/ËˆfiËdbÃ¦k/", meaning: "åé¦ˆï¼›æ„è§", example: "I'd appreciate your feedback on this proposal." },
      { word: "stakeholder", phonetic: "/ËˆsteÉªkhoÊŠldÉ™r/", meaning: "åˆ©ç›Šç›¸å…³è€…", example: "We need to consider all stakeholders' interests." },
      { word: "milestone", phonetic: "/ËˆmaÉªlstoÊŠn/", meaning: "é‡Œç¨‹ç¢‘", example: "This is a significant milestone for our company." },
      { word: "priority", phonetic: "/praÉªËˆÉ”ËrÉ™ti/", meaning: "ä¼˜å…ˆäº‹é¡¹", example: "Customer satisfaction is our top priority." },
      { word: "streamline", phonetic: "/ËˆstriËmlaÉªn/", meaning: "ç²¾ç®€ï¼›ä½¿é«˜æ•ˆ", example: "We need to streamline our processes." },
      { word: "delegate", phonetic: "/ËˆdelÉªÉ¡eÉªt/", meaning: "å§”æ´¾ï¼›æˆæƒ", example: "Learn to delegate tasks to your team members." },
      { word: "benchmark", phonetic: "/ËˆbentÊƒmÉ‘Ërk/", meaning: "åŸºå‡†ï¼›æ ‡æ†", example: "This serves as a benchmark for future projects." },
      { word: "leverage", phonetic: "/ËˆlevÉ™rÉªdÊ’/", meaning: "åˆ©ç”¨ï¼›å€ŸåŠ©", example: "We can leverage our expertise in this area." },
      { word: "scalable", phonetic: "/ËˆskeÉªlÉ™bl/", meaning: "å¯æ‰©å±•çš„", example: "We need a scalable solution for growth." },
      { word: "synergy", phonetic: "/ËˆsÉªnÉ™rdÊ’i/", meaning: "ååŒæ•ˆåº”", example: "The merger created significant synergies." },
      { word: "optimize", phonetic: "/ËˆÉ‘ËptÉªmaÉªz/", meaning: "ä¼˜åŒ–", example: "We need to optimize our workflow." },
      { word: "proactive", phonetic: "/proÊŠËˆÃ¦ktÉªv/", meaning: "ç§¯æä¸»åŠ¨çš„", example: "Be proactive in identifying potential issues." },
      { word: "consensus", phonetic: "/kÉ™nËˆsensÉ™s/", meaning: "å…±è¯†", example: "We need to reach a consensus on this matter." },
      { word: "pipeline", phonetic: "/ËˆpaÉªplaÉªn/", meaning: "æ¸ é“ï¼›å·¥ä½œæµç¨‹", example: "We have several projects in the pipeline." },
      { word: "deliverable", phonetic: "/dÉªËˆlÉªvÉ™rÉ™bl/", meaning: "äº¤ä»˜ç‰©ï¼›æˆæœ", example: "What are the key deliverables for this project?" },
      { word: "alignment", phonetic: "/É™ËˆlaÉªnmÉ™nt/", meaning: "ä¸€è‡´ï¼›åè°ƒ", example: "We need better alignment between departments." },
      { word: "initiative", phonetic: "/ÉªËˆnÉªÊƒÉ™tÉªv/", meaning: "å€¡è®®ï¼›ä¸»åŠ¨æ€§", example: "She took the initiative to solve the problem." },
      { word: "metrics", phonetic: "/ËˆmetrÉªks/", meaning: "æŒ‡æ ‡ï¼›åº¦é‡", example: "What metrics are we using to measure success?" },
      { word: "feasible", phonetic: "/ËˆfiËzÉ™bl/", meaning: "å¯è¡Œçš„", example: "Is this plan feasible within our budget?" },
      { word: "robust", phonetic: "/roÊŠËˆbÊŒst/", meaning: "å¼ºå¥çš„ï¼›ç¨³å¥çš„", example: "We need a more robust system." },
      { word: "pivot", phonetic: "/ËˆpÉªvÉ™t/", meaning: "è½¬å‹ï¼›è°ƒæ•´æ–¹å‘", example: "The company decided to pivot its strategy." },
      { word: "workflow", phonetic: "/ËˆwÉœËrkfloÊŠ/", meaning: "å·¥ä½œæµç¨‹", example: "Let's discuss how to improve our workflow." },
      { word: "touchpoint", phonetic: "/ËˆtÊŒtÊƒpÉ”Éªnt/", meaning: "æ¥è§¦ç‚¹", example: "Every touchpoint with customers matters." },
      { word: "bandwidth", phonetic: "/ËˆbÃ¦ndwÉªdÎ¸/", meaning: "å¸¦å®½ï¼›ç²¾åŠ›", example: "I don't have the bandwidth to take on more work." },
      { word: "actionable", phonetic: "/ËˆÃ¦kÊƒÉ™nÉ™bl/", meaning: "å¯æ‰§è¡Œçš„", example: "We need actionable insights from this data." },
      { word: "bottom line", phonetic: "/ËˆbÉ‘ËtÉ™m laÉªn/", meaning: "åº•çº¿ï¼›æœ€ç»ˆç»“æœ", example: "The bottom line is we need to cut costs." }
    ];
    
    let currentIndex = 0;
    let learnedWords = [];
    let isShowingMeaning = false;
    let customVocabIds = []; // å­˜å‚¨è‡ªå®šä¹‰è¯æ±‡çš„ IDï¼Œç”¨äºæ›´æ–°çŠ¶æ€
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      updateDayBadge();
      
      // é¢„åŠ è½½è¯­éŸ³åˆ—è¡¨
      if (window.speechSynthesis) {
        speechSynthesis.getVoices();
        speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
      }
      
      // æ ¹æ®æ¨¡å¼åˆå§‹åŒ–
      if (isCustomMode) {
        await loadCustomVocabulary();
      } else {
        loadProgress();
        showCurrentWord();
        renderVocabList();
      }
    });
    
    // åŠ è½½è‡ªå®šä¹‰ç´ æçš„è¯æ±‡
    async function loadCustomVocabulary() {
      try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.querySelector('h1').textContent = 'ğŸ“– è¯æ±‡å­¦ä¹  Â· åŠ è½½ä¸­...';
        
        const result = await Materials.getVocabularies(materialId);
        const vocabs = result.data || [];
        
        if (vocabs.length === 0) {
          alert('è¯¥ç´ ææ²¡æœ‰ç”Ÿæˆè¯æ±‡ï¼Œè¯·è¿”å›ç´ æé¡µé¢');
          window.location.href = 'materials.html';
          return;
        }
        
        // è½¬æ¢æ•°æ®æ ¼å¼
        todayVocabulary = vocabs.map(v => ({
          id: v.id,
          word: v.word,
          phonetic: v.phonetic || '',
          meaning: v.translation,
          example: v.example || '',
          example_translation: v.example_translation || '',
          definition: v.definition || '',
          synonyms: v.synonyms || [],
          collocations: v.collocations || [],
          is_learned: v.is_learned,
          is_mastered: v.is_mastered
        }));
        
        customVocabIds = vocabs.map(v => v.id);
        
        // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœªå­¦ä¹ çš„è¯æ±‡
        currentIndex = todayVocabulary.findIndex(v => !v.is_learned);
        if (currentIndex === -1) currentIndex = 0;
        
        // æ›´æ–°æ ‡é¢˜
        document.querySelector('h1').textContent = 'ğŸ“– è¯æ±‡å­¦ä¹  Â· è‡ªå®šä¹‰ç´ æ';
        
        // åˆå§‹åŒ–å·²å­¦è¯æ±‡åˆ—è¡¨
        learnedWords = todayVocabulary
          .map((v, i) => v.is_learned ? i : -1)
          .filter(i => i >= 0);
        
        showCurrentWord();
        renderVocabList();
        
      } catch (error) {
        console.error('Failed to load custom vocabulary:', error);
        alert('åŠ è½½è¯æ±‡å¤±è´¥: ' + error.message);
        window.location.href = 'materials.html';
      }
    }
    
    function updateDayBadge() {
      const currentDay = Storage.getCurrentDay();
      document.getElementById('dayBadge').textContent = `Day ${currentDay} / 30`;
    }
    
    function loadProgress() {
      const saved = localStorage.getItem('em_vocab_progress');
      if (saved) {
        const data = JSON.parse(saved);
        if (data.date === Storage.getTodayString()) {
          currentIndex = data.currentIndex;
          learnedWords = data.learnedWords;
        }
      }
    }
    
    function saveProgress() {
      localStorage.setItem('em_vocab_progress', JSON.stringify({
        date: Storage.getTodayString(),
        currentIndex,
        learnedWords
      }));
    }
    
    function showCurrentWord() {
      if (currentIndex >= todayVocabulary.length) {
        showComplete();
        return;
      }
      
      const vocab = todayVocabulary[currentIndex];
      document.getElementById('vocabWord').textContent = vocab.word;
      document.getElementById('vocabPhonetic').textContent = vocab.phonetic;
      document.getElementById('vocabMeaning').textContent = vocab.meaning;
      document.getElementById('vocabExampleText').textContent = `"${vocab.example}"`;
      
      // éšè—é‡Šä¹‰
      document.getElementById('vocabMeaning').classList.add('hidden');
      document.getElementById('vocabExample').classList.add('hidden');
      document.getElementById('showBtn').classList.remove('hidden');
      document.getElementById('knowBtn').classList.add('hidden');
      document.getElementById('unknownBtn').classList.add('hidden');
      
      isShowingMeaning = false;
      updateProgress();
    }
    
    function showMeaning() {
      document.getElementById('vocabMeaning').classList.remove('hidden');
      document.getElementById('vocabExample').classList.remove('hidden');
      document.getElementById('showBtn').classList.add('hidden');
      document.getElementById('knowBtn').classList.remove('hidden');
      document.getElementById('unknownBtn').classList.remove('hidden');
      isShowingMeaning = true;
    }
    
    function markKnown() {
      if (!learnedWords.includes(currentIndex)) {
        learnedWords.push(currentIndex);
      }
      
      // å¦‚æœæ˜¯è‡ªå®šä¹‰æ¨¡å¼ï¼ŒåŒæ­¥åˆ°åç«¯
      if (isCustomMode && customVocabIds[currentIndex]) {
        Materials.updateVocabulary(materialId, customVocabIds[currentIndex], {
          is_learned: true
        }).catch(err => console.error('Failed to update vocab status:', err));
      }
      
      nextWord();
    }
    
    function markUnknown() {
      // ä¸è®°å…¥å·²å­¦ï¼Œç¨åå¤ä¹ 
      nextWord();
    }
    
    function nextWord() {
      currentIndex++;
      saveProgress();
      showCurrentWord();
      renderVocabList();
    }
    
    function updateProgress() {
      const total = todayVocabulary.length;
      const progress = (currentIndex / total) * 100;
      
      document.getElementById('progressText').textContent = `${currentIndex} / ${total}`;
      document.getElementById('progressFill').style.width = `${progress}%`;
      document.getElementById('learnedCount').textContent = `å·²å­¦ ${learnedWords.length} è¯`;
    }
    
    function showComplete() {
      document.getElementById('vocabCard').classList.add('hidden');
      document.getElementById('completeCard').classList.remove('hidden');
      
      // æ›´æ–°å®Œæˆä¿¡æ¯
      const completeText = document.querySelector('#completeCard p.text-muted');
      if (completeText) {
        completeText.textContent = `ä½ å·²ç»å­¦ä¹ äº† ${learnedWords.length} ä¸ªè¯æ±‡`;
      }
      
      // è‡ªå®šä¹‰æ¨¡å¼ï¼šè¿”å›ç´ æé¡µé¢
      if (isCustomMode) {
        const returnBtn = document.querySelector('#completeCard button');
        if (returnBtn) {
          returnBtn.textContent = 'è¿”å›æˆ‘çš„ç´ æ';
          returnBtn.onclick = () => location.href = 'materials.html';
        }
      } else {
        // é»˜è®¤æ¨¡å¼ï¼šæ›´æ–°å­˜å‚¨
        Storage.addWordsLearned(learnedWords.length);
        Storage.updateTodayTask('vocabulary', true);
        Storage.addStudyTime(15);
        
        const progress = Storage.getProgress();
        progress.vocabulary = Math.min(100, (progress.vocabulary || 40) + 2);
        Storage.setProgress(progress);
      }
    }
    
    function renderVocabList() {
      const list = document.getElementById('vocabList');
      list.innerHTML = todayVocabulary.map((vocab, index) => `
        <div class="vocab-item ${learnedWords.includes(index) ? 'learned' : ''}" onclick="showWordDetail(${index})">
          <div class="vocab-item-word">
            <span class="vocab-item-word-text">${vocab.word}</span>
            <button class="speak-btn-mini" onclick="event.stopPropagation(); speakWordByIndex(${index})" title="æ’­æ”¾å‘éŸ³">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                <path d="M15.54 8.46a5 5 0 010 7.07"/>
              </svg>
            </button>
          </div>
          <div class="vocab-item-meaning">${vocab.meaning}</div>
        </div>
      `).join('');
    }
    
    function showWordDetail(index) {
      currentIndex = index;
      switchTab('flashcard');
      showCurrentWord();
      showMeaning();
    }
    
    function switchTab(tabId) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
      document.getElementById(`${tabId}-tab`).classList.add('active');
    }
    
    // ========== è¯­éŸ³æœ—è¯»åŠŸèƒ½ ==========
    let currentAudio = null;
    
    // æ’­æ”¾å½“å‰å•è¯å‘éŸ³
    function speakWord() {
      if (currentIndex >= todayVocabulary.length) return;
      const word = todayVocabulary[currentIndex].word;
      speak(word, document.getElementById('speakBtn'));
    }
    
    // æ’­æ”¾æŒ‡å®šç´¢å¼•çš„å•è¯
    function speakWordByIndex(index) {
      if (index >= 0 && index < todayVocabulary.length) {
        const word = todayVocabulary[index].word;
        // æ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®æ·»åŠ åŠ¨ç”»
        const buttons = document.querySelectorAll('.vocab-list .speak-btn-mini');
        speak(word, buttons[index]);
      }
    }
    
    // æ’­æ”¾å½“å‰ä¾‹å¥å‘éŸ³
    function speakExample() {
      if (currentIndex >= todayVocabulary.length) return;
      const example = todayVocabulary[currentIndex].example;
      // ä¾‹å¥ä½¿ç”¨ Web Speech APIï¼Œå› ä¸ºåœ¨çº¿è¯å…¸ API ä¸é€‚åˆè¯»å¥å­
      speakSentence(example, document.getElementById('speakExampleBtn'));
    }
    
    // æ’­æ”¾å¥å­ - ä¸“é—¨ç”¨äºä¾‹å¥å‘éŸ³
    function speakSentence(text, btnElement) {
      // åœæ­¢ä¹‹å‰çš„éŸ³é¢‘
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
      
      // åœæ­¢ä¹‹å‰çš„è¯­éŸ³åˆæˆ
      if (window.speechSynthesis) {
        speechSynthesis.cancel();
      }
      
      // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„ speaking çŠ¶æ€
      document.querySelectorAll('.speak-btn, .speak-btn-mini').forEach(btn => {
        btn.classList.remove('speaking');
      });
      
      // æ·»åŠ åŠ¨ç”»æ•ˆæœ
      if (btnElement) {
        btnElement.classList.add('speaking');
      }
      
      // ä½¿ç”¨ Web Speech API æœ—è¯»å¥å­
      if (!window.speechSynthesis) {
        console.log('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ');
        if (btnElement) btnElement.classList.remove('speaking');
        return;
      }
      
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'en-US';
      utterance.rate = 0.9;  // ç¨æ…¢ä¸€ç‚¹ï¼Œä¾¿äºå­¦ä¹ 
      utterance.pitch = 1;
      utterance.volume = 1;
      
      // è·å–è‹±è¯­è¯­éŸ³
      const voices = speechSynthesis.getVoices();
      const englishVoice = voices.find(v => v.lang === 'en-US') ||
                          voices.find(v => v.lang.startsWith('en-US')) ||
                          voices.find(v => v.lang.includes('en-US')) ||
                          voices.find(v => v.lang === 'en-GB') ||
                          voices.find(v => v.lang.startsWith('en'));
      if (englishVoice) {
        utterance.voice = englishVoice;
      }
      
      utterance.onend = () => {
        if (btnElement) btnElement.classList.remove('speaking');
      };
      
      utterance.onerror = () => {
        if (btnElement) btnElement.classList.remove('speaking');
      };
      
      speechSynthesis.speak(utterance);
    }
    
    // æ ¸å¿ƒå‘éŸ³å‡½æ•° - ä½¿ç”¨åœ¨çº¿è¯å…¸å‘éŸ³
    function speak(text, btnElement) {
      // åœæ­¢ä¹‹å‰çš„éŸ³é¢‘
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
      
      // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„ speaking çŠ¶æ€
      document.querySelectorAll('.speak-btn, .speak-btn-mini').forEach(btn => {
        btn.classList.remove('speaking');
      });
      
      // æ·»åŠ åŠ¨ç”»æ•ˆæœ
      if (btnElement) {
        btnElement.classList.add('speaking');
      }
      
      // ä½¿ç”¨æœ‰é“è¯å…¸çš„å‘éŸ³ APIï¼ˆç¾å¼å‘éŸ³ï¼‰
      const audioUrl = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(text)}&type=2`;
      
      currentAudio = new Audio(audioUrl);
      currentAudio.volume = 1;
      
      currentAudio.onended = () => {
        if (btnElement) {
          btnElement.classList.remove('speaking');
        }
        currentAudio = null;
      };
      
      currentAudio.onerror = () => {
        // å¦‚æœæœ‰é“è¯å…¸å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ Google Translate TTS ä½œä¸ºå¤‡é€‰
        console.log('æœ‰é“è¯å…¸å‘éŸ³åŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡é€‰æ–¹æ¡ˆ...');
        tryGoogleTTS(text, btnElement);
      };
      
      currentAudio.play().catch(err => {
        console.log('æ’­æ”¾å¤±è´¥:', err);
        // å°è¯•å¤‡é€‰æ–¹æ¡ˆ
        tryGoogleTTS(text, btnElement);
      });
    }
    
    // Google Translate TTS ä½œä¸ºå¤‡é€‰
    function tryGoogleTTS(text, btnElement) {
      const googleUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=en&client=tw-ob`;
      
      currentAudio = new Audio(googleUrl);
      currentAudio.volume = 1;
      
      currentAudio.onended = () => {
        if (btnElement) {
          btnElement.classList.remove('speaking');
        }
        currentAudio = null;
      };
      
      currentAudio.onerror = () => {
        // å¦‚æœ Google ä¹Ÿå¤±è´¥ï¼Œå›é€€åˆ° Web Speech API
        console.log('åœ¨çº¿å‘éŸ³å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°è¯­éŸ³åˆæˆ');
        speakWithWebSpeech(text, btnElement);
      };
      
      currentAudio.play().catch(() => {
        speakWithWebSpeech(text, btnElement);
      });
    }
    
    // Web Speech API ä½œä¸ºæœ€åå¤‡é€‰
    function speakWithWebSpeech(text, btnElement) {
      if (!window.speechSynthesis) {
        if (btnElement) btnElement.classList.remove('speaking');
        return;
      }
      
      speechSynthesis.cancel();
      
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'en-US';
      utterance.rate = 0.9;
      utterance.pitch = 1;
      utterance.volume = 1;
      
      // è·å–è‹±è¯­è¯­éŸ³
      const voices = speechSynthesis.getVoices();
      const englishVoice = voices.find(v => v.lang.includes('en-US')) ||
                          voices.find(v => v.lang.includes('en-GB')) ||
                          voices.find(v => v.lang.includes('en'));
      if (englishVoice) {
        utterance.voice = englishVoice;
      }
      
      utterance.onend = () => {
        if (btnElement) btnElement.classList.remove('speaking');
      };
      
      utterance.onerror = () => {
        if (btnElement) btnElement.classList.remove('speaking');
      };
      
      speechSynthesis.speak(utterance);
    }
    
    // é”®ç›˜å¿«æ·é”®æ”¯æŒ
    document.addEventListener('keydown', function(e) {
      // æŒ‰ç©ºæ ¼é”®æ’­æ”¾å‘éŸ³
      if (e.code === 'Space' && !e.target.matches('input, textarea, button')) {
        e.preventDefault();
        speakWord();
      }
      // æŒ‰ Enter é”®æ˜¾ç¤ºé‡Šä¹‰æˆ–ä¸‹ä¸€ä¸ª
      if (e.code === 'Enter' && !e.target.matches('input, textarea, button')) {
        e.preventDefault();
        if (!isShowingMeaning) {
          showMeaning();
        }
      }
      // æŒ‰å·¦å³ç®­å¤´åˆ‡æ¢å•è¯
      if (e.code === 'ArrowRight' && isShowingMeaning) {
        markKnown();
      }
      if (e.code === 'ArrowLeft' && isShowingMeaning) {
        markUnknown();
      }
    });
  </script>
</body>
</html>
